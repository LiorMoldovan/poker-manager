import { GamePlayer, Settlement, SkippedTransfer } from '../types';
import { formatCurrency } from './calculations';

export const generateGameSummary = (
  date: string,
  players: GamePlayer[],
  settlements: Settlement[],
  skippedTransfers: SkippedTransfer[],
  chipGap?: number | null,
  chipGapPerPlayer?: number | null
): string => {
  const gameDate = new Date(date).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  let summary = `ðŸƒ *Poker Night Results*\n`;
  summary += `ðŸ“… ${gameDate}\n\n`;

  // Sort players by profit (winners first)
  const sortedPlayers = [...players].sort((a, b) => b.profit - a.profit);

  // LTR mark to force left-to-right display in WhatsApp
  const LTR = '\u200E';
  
  summary += `ðŸ’° *Results:*\n`;
  sortedPlayers.forEach((player, index) => {
    const emoji = player.profit > 0 ? 'ðŸŸ¢' : player.profit < 0 ? 'ðŸ”´' : 'âšª';
    // Add medals for top 3 positions
    let medal = '';
    if (index === 0) medal = ' ðŸ¥‡';
    else if (index === 1) medal = ' ðŸ¥ˆ';
    else if (index === 2) medal = ' ðŸ¥‰';
    
    const profitText = player.profit >= 0 
      ? `â‚ª+${Math.abs(player.profit).toFixed(1)}` 
      : `â‚ª-${Math.abs(player.profit).toFixed(1)}`;
    summary += `${LTR}${emoji} ${player.playerName}: ${profitText}${medal}\n`;
  });

  // Show chip gap adjustment if present
  if (chipGap && chipGap !== 0) {
    summary += `\nâš ï¸ *Chip Count Adjustment:*\n`;
    if (chipGap > 0) {
      summary += `Counted â‚ª${chipGap.toFixed(1)} extra â€¢ Adjusted â‚ª-${Math.abs(chipGapPerPlayer || 0).toFixed(1)} per player\n`;
    } else {
      summary += `Counted â‚ª${Math.abs(chipGap).toFixed(1)} short â€¢ Adjusted â‚ª+${Math.abs(chipGapPerPlayer || 0).toFixed(1)} per player\n`;
    }
  }

  if (settlements.length > 0) {
    summary += `\nðŸ’¸ *Settlements:*\n`;
    settlements.forEach(s => {
      // s.from = loser (pays), s.to = winner (receives)
      summary += `${s.from} ×ž×©×œ× ×œ${s.to}: â‚ª${s.amount.toFixed(1)}\n`;
    });
  }

  if (skippedTransfers.length > 0) {
    summary += `\nðŸ’¡ *Small amounts (not mandatory):*\n`;
    skippedTransfers.forEach(s => {
      summary += `${s.from} ×ž×©×œ× ×œ${s.to}: â‚ª${s.amount.toFixed(1)}\n`;
    });
  }

  summary += `\n_Generated by Poker Manager_ ðŸŽ²`;

  return summary;
};

export const shareToWhatsApp = (text: string): void => {
  const encoded = encodeURIComponent(text);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
};

