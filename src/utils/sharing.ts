import { GamePlayer, Settlement, SkippedTransfer, ChipValue } from '../types';
import { formatCurrency, cleanNumber } from './calculations';

// Calculate total chips for a player
const getTotalChipsForPlayer = (player: GamePlayer, chipValues: ChipValue[]): number => {
  let total = 0;
  for (const [chipId, count] of Object.entries(player.chipCounts)) {
    const chip = chipValues.find(c => c.id === chipId);
    if (chip) {
      total += count * chip.value;
    }
  }
  return total;
};

export const generateGameSummary = (
  date: string,
  players: GamePlayer[],
  settlements: Settlement[],
  skippedTransfers: SkippedTransfer[],
  chipGap?: number | null,
  chipGapPerPlayer?: number | null,
  rebuyValue?: number,
  chipValues?: ChipValue[]
): string => {
  const gameDate = new Date(date).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  let summary = `ðŸƒ *Poker Night Results*\n`;
  summary += `ðŸ“… ${gameDate}\n\n`;

  // Sort players by profit (winners first)
  const sortedPlayers = [...players].sort((a, b) => b.profit - a.profit);

  // LTR mark to force left-to-right display in WhatsApp
  const LTR = '\u200E';
  
  summary += `ðŸ’° *Results:*\n`;
  sortedPlayers.forEach((player, index) => {
    const emoji = player.profit > 0 ? 'ðŸŸ¢' : player.profit < 0 ? 'ðŸ”´' : 'âšª';
    // Add medals for top 3 positions
    let medal = '';
    if (index === 0) medal = ' ðŸ¥‡';
    else if (index === 1) medal = ' ðŸ¥ˆ';
    else if (index === 2) medal = ' ðŸ¥‰';
    
    const profitText = player.profit >= 0 
      ? `+â‚ª${cleanNumber(Math.abs(player.profit))}` 
      : `-â‚ª${cleanNumber(Math.abs(player.profit))}`;
    
    // Add chips and rebuys info
    const totalChips = chipValues ? getTotalChipsForPlayer(player, chipValues) : 0;
    const rebuyAmount = rebuyValue ? player.rebuys * rebuyValue : 0;
    const detailsText = chipValues && rebuyValue 
      ? ` | ðŸŽ°${totalChips.toLocaleString()} | ðŸ”„${player.rebuys}(â‚ª${cleanNumber(rebuyAmount)})`
      : '';
    
    summary += `${LTR}${emoji} ${player.playerName}: ${profitText}${medal}${detailsText}\n`;
  });

  // Show chip gap adjustment if present
  if (chipGap && chipGap !== 0) {
    summary += `\nâš ï¸ *Chip Count Adjustment:*\n`;
    if (chipGap > 0) {
      summary += `Counted â‚ª${cleanNumber(chipGap)} extra â€¢ Adjusted -â‚ª${cleanNumber(Math.abs(chipGapPerPlayer || 0))} per player\n`;
    } else {
      summary += `Counted â‚ª${cleanNumber(Math.abs(chipGap))} short â€¢ Adjusted +â‚ª${cleanNumber(Math.abs(chipGapPerPlayer || 0))} per player\n`;
    }
  }

  if (settlements.length > 0) {
    summary += `\nðŸ’¸ *Settlements:*\n`;
    settlements.forEach(s => {
      // s.from = loser (pays), s.to = winner (receives)
      summary += `${s.from} ×ž×©×œ× ×œ${s.to}: â‚ª${cleanNumber(s.amount)}\n`;
    });
  }

  if (skippedTransfers.length > 0) {
    summary += `\nðŸ’¡ *Small amounts (not mandatory):*\n`;
    skippedTransfers.forEach(s => {
      summary += `${s.from} ×ž×©×œ× ×œ${s.to}: â‚ª${cleanNumber(s.amount)}\n`;
    });
  }

  summary += `\n_Generated by Poker Manager_ ðŸŽ²`;

  return summary;
};

export const shareToWhatsApp = (text: string): void => {
  const encoded = encodeURIComponent(text);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
};

