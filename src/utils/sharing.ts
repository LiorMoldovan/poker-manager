import { GamePlayer, Settlement, SkippedTransfer } from '../types';
import { formatCurrency } from './calculations';

export const generateGameSummary = (
  date: string,
  players: GamePlayer[],
  settlements: Settlement[],
  skippedTransfers: SkippedTransfer[],
  chipGap?: number | null,
  chipGapPerPlayer?: number | null
): string => {
  const gameDate = new Date(date).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  let summary = `ðŸƒ *Poker Night Results*\n`;
  summary += `ðŸ“… ${gameDate}\n\n`;

  // Sort players by profit (winners first)
  const sortedPlayers = [...players].sort((a, b) => b.profit - a.profit);

  // LTR mark to force left-to-right display in WhatsApp
  const LTR = '\u200E';
  
  summary += `ðŸ’° *Results:*\n`;
  sortedPlayers.forEach((player, index) => {
    const emoji = player.profit > 0 ? 'ðŸŸ¢' : player.profit < 0 ? 'ðŸ”´' : 'âšª';
    const medal = index === 0 && player.profit > 0 ? ' ðŸ†' : '';
    const profitText = player.profit >= 0 
      ? `+â‚ª${Math.abs(player.profit)}` 
      : `â‚ª${Math.abs(player.profit)}-`;
    summary += `${LTR}${emoji} ${player.playerName}: ${profitText}${medal}\n`;
  });

  // Show chip gap adjustment if present
  if (chipGap && chipGap !== 0) {
    summary += `\nâš ï¸ *Chip Count Adjustment:*\n`;
    if (chipGap > 0) {
      summary += `Counted â‚ª${chipGap} extra â€¢ Adjusted -â‚ª${Math.abs(chipGapPerPlayer || 0)} per player\n`;
    } else {
      summary += `Counted â‚ª${Math.abs(chipGap)} short â€¢ Adjusted +â‚ª${Math.abs(chipGapPerPlayer || 0)} per player\n`;
    }
  }

  if (settlements.length > 0) {
    summary += `\nðŸ’¸ *Settlements:*\n`;
    settlements.forEach(s => {
      // Format: "payer â†’ receiver: amount" with LTR mark
      summary += `${LTR}${s.from} â†’ ${s.to}: â‚ª${s.amount}\n`;
    });
  }

  if (skippedTransfers.length > 0) {
    summary += `\nðŸ’¡ *Note - small amounts (still to be paid):*\n`;
    skippedTransfers.forEach(s => {
      summary += `${LTR}${s.from} â†’ ${s.to}: â‚ª${s.amount}\n`;
    });
  }

  summary += `\n_Generated by Poker Manager_ ðŸŽ²`;

  return summary;
};

export const shareToWhatsApp = (text: string): void => {
  const encoded = encodeURIComponent(text);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
};

